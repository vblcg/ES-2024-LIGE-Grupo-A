<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Horário ISCTE</title>
    <script src="luxon.js"></script>
    <link href="https://unpkg.com/tabulator-tables/dist/css/tabulator.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <link rel="stylesheet" href="HorárioStyleSheet.css">

</head>

<body>

        <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h5 class="modal-title" id="myModalLabel">Alterar aula</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
    
            <!-- Modal Body -->
            <div class="modal-body">
            <!-- Form -->
                <form>
                    <div class="form-group">
                        <p class="first_label_input">Horário Preferencial:</p>
                        <p>Semana do semestre:</p>
                        <select class="form-select" id="semanaPref" aria-label="Default select example">
                            <option selected>Semana a selecionar:</option>
                            <option value="1">1ª Semana</option>
                            <option value="2">2ª Semana</option>
                            <option value="3">3ª Semana</option>
                            <option value="4">4ª Semana</option>
                            <option value="5">5ª Semana</option>
                            <option value="6">6ª Semana</option>
                            <option value="7">7ª Semana</option>
                            <option value="8">8ª Semana</option>
                            <option value="9">9ª Semana</option>
                            <option value="10">10ª Semana</option>
                            <option value="11">11ª Semana</option>
                            <option value="12">12ª Semana</option>
                            <option value="13">13ª Semana</option>
                            <option value="14">14ª Semana</option>
                            <option value="15">15ª Semana</option>
                            <option value="16">16ª Semana</option>
                            <option value="17">17ª Semana</option>
                            <option value="18">18ª Semana</option>
                            <option value="19">19ª Semana</option>
                            <option value="20">20ª Semana</option>
                            <option value="21">21ª Semana</option>
                        </select>
                        <p>Dia da semana:</p>
                        <select class="form-select" id="diaDaSemanaPref" aria-label="Default select example">
                            <option selected>Dia da semana a selecionar:</option>
                            <option value="Seg">Segunda-feira</option>
                            <option value="Ter">Terça-feira</option>
                            <option value="Qua">Quarta-feira</option>
                            <option value="Qui">Quinta-feira</option>
                            <option value="Sex">Sexta-feira</option>
                        </select>
                        <p>Altura do dia:</p>
                        <select class="form-select" id="alturaDoDiaPref" aria-label="Default select example">
                            <option selected>Altura do dia a selecionar:</option>
                            <option>Manhã (8:00 - 13:00)</option>
                            <option>Tarde (13:00 - 18:00)</option>
                            <option>Noite (18:00 - 23:00)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <p class="label_input">Preferência de sala</p>
                        <div id="preferencias-container">
                            <p>Preferência nº1:</p>
                            <select class="form-select" id="preferenciaSala1" aria-label="Default select example">
                                <option selected>Escolha uma Preferência</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-secondary" id="addPreferenceBtn">Adicionar Preferência</button>
                        
                    </div>
                    <div class="form-group">
                        <div id="salasInaceitaveis-container">
                        <p>Salas Inaceitáveis:</p>
                        <select class="form-select" id='salasInaceitaveis' aria-label="Default select example">
                            <option selected>Indique as salas inaceitáveis</option>
                        </select>
                        </div>
                        <button type="button" class="btn btn-secondary" id="addSalaInaceitavel">Adicionar salas inaceitáveis</button>
                    </div>
                
            </div>
    
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="guardarButton">Guardar</button>
            </div>
                </form>

        </div>
        </div>
    </div>
    <script type="text/javascript">
        var table; // Declarar a variável da tabela
        var nomesSalas;
        var salas;
        var tiposDeSala;
        var horario;

        /**
         * Esconder e Mostrar colunas
         * @param {string} columnName - Nome da coluna
        */
        function toggleColumn(columnName) {
                var column = table.getColumn(columnName);
                if (column) {
                    column.toggle();
                    adjustTableWidth();
                }
            }
    </script>

    <h1>Calendário de aulas:</h1>
    <div id="toggle-buttons">
        <a>Esconder/mostrar colunas:</a>
        <a class="link" href="##" id="Curso" onclick="toggleColumn('Curso')">Curso,</a>
        <a class="link" href="##" id="UC" onclick="toggleColumn('UC')"> UC,</a>
        <a class="link" href="##" id="Turno" onclick="toggleColumn('Turno')"> Turno,</a>
        <a class="link" href="##" id="Turma" onclick="toggleColumn('Turma')"> Turma,</a>
        <a class="link" href="##" id="Inscritos" onclick="toggleColumn('Inscritos no Turno')"> Inscritos no Turno,</a>
        <a class="link" href="##" id="DiaSemana" onclick="toggleColumn('Dia da Semana')"> Dia da Semana,</a>
        <a class="link" href="##" id="HoraInicio" onclick="toggleColumn('Hora Início da Aula')"> Hora Início da Aula,</a>
        <a class="link" href="##" id="HoraFim" onclick="toggleColumn('Hora Fim da Aula')"> Hora Fim da Aula,</a>
        <a class="link" href="##" id="DataAula" onclick="toggleColumn('Data da aula')"> Data da aula,</a>
        <a class="link" href="##" id="CaracteristicasSala" onclick="toggleColumn('Caracteristicas da sala pedida para a aula')"> Caracteristicas da sala pedida para a aula,</a>
        <a class="link" href="##" id="SalaAtribuida" onclick="toggleColumn('Sala atribuida a aula')"> Sala atribuida a aula,</a>
        <a class="link" href="##" id="SemanaAno" onclick="toggleColumn('Semana do ano')"> Semana do ano,</a>
        <a class="link" href="##" id="SemanaSemestre" onclick="toggleColumn('Semana do semestre')"> Semana do semestre,</a>
        <a class="link" href="##" id="SemanaSemestre" onclick="toggleColumn('Alterar aula')"> Alterar aula</a>

        <br><br>
    </div>
    <div id="table-horario">
    <script type="text/javascript">

    const pathJsonHorario = 'Horário.json';
    const pathJsonSalas = 'CaracterizacaoDasSalas.json';

    var minMaxFilterEditor = function(cell, onRendered, success, cancel, editorParams){

        var end;

        var container = document.createElement("span");

        //create and style inputs
        var start = document.createElement("input");
        start.setAttribute("type", "number");
        start.setAttribute("placeholder", "Min");
        start.setAttribute("min", 0);
        start.setAttribute("max", 300);
        start.style.padding = "4px";
        start.style.width = "50%";
        start.style.boxSizing = "border-box";

        start.value = cell.getValue();

        /**
         * Constroi os valores do start e do end do filtro minMax.
        */
        function buildValues(){
            success({
                start:start.value,
                end:end.value,
            });
        }
        
         /**
          * Trata de eventos keypress para o editor.
          * @param {Event} e - Evento pressionado.
         */
        function keypress(e){
            if(e.keyCode == 13){
                buildValues();
            }

            if(e.keyCode == 27){
                cancel();
            }
        }

        end = start.cloneNode();
        end.setAttribute("placeholder", "Max");

        start.addEventListener("change", buildValues);
        start.addEventListener("blur", buildValues);
        start.addEventListener("keydown", keypress);

        end.addEventListener("change", buildValues);
        end.addEventListener("blur", buildValues);
        end.addEventListener("keydown", keypress);


        container.appendChild(start);
        container.appendChild(end);

        return container;
    }
    
    var minMaxFilterFunction = function (headerValue, rowValue, rowData, filterParams) {
        if (rowValue !== null && rowValue !== undefined) {
            if (headerValue.start !== "") {
                if (headerValue.end !== "") {
                    return rowValue >= parseFloat(headerValue.start) && rowValue <= parseFloat(headerValue.end);
                } else {
                    return rowValue >= parseFloat(headerValue.start);
                }
            } else {
                if (headerValue.end !== "") {
                    return rowValue <= parseFloat(headerValue.end);
                }
            }
        }

        return true;
    }

    var alterarAulaButton = function(cell, formatterParams, onRendered) {
        var button = document.createElement("button");
        button.innerHTML = "Alterar aula";
        button.classList.add("alterar-aula-button");
        button.addEventListener("click", function() {
            $('#myModal').modal('show');
        });
        return button;
    };

    


    /** 
     * Lê os dados do ficheiro json e cria uma tabela do tabulator com os mesmos
     */
    fetch(pathJsonHorario)
    .then(response => {
        // Verificar se o request foi bem sucedido
        if (!response.ok) {
            throw new Error(`Failed to fetch ${pathJsonHorario}: ${response.statusText}`);
        }

        // Parse the JSON data
        return response.json();
    })

    .then(data => {
        // 'data' é agora um array que contém o conteúdo do ficheiro JSON

        horario = data;

        function concatenateColumns(jsonData, column1, column2) {
            const concatenatedValues = [];
            jsonData.forEach(item => {
                concatenatedValues.push(item[column1] + '-' + item[column2]);
            });
            return concatenatedValues;
        }


        table = new Tabulator("#table-horario", {
        height:"700px",
        layout:"fitDataTable",
        pagination:"local",
        resizableRows: true,
        movableColumns: true,
        data: data,
        columns: [
            {title: "Curso", field:"Curso", headerFilter: "input"},
            {title: "UC", field:"UC", headerFilter:"input"},
            {title: "Turno", field:"Turno", headerFilter:"input", sorter:"alphanum"},
            {title: "Turma", field:"Turma", headerFilter:"input"},
            {title: "Inscritos no Turno", field:"Inscritos no Turno", headerFilter:"input", sorter:"number",headerFilter:minMaxFilterEditor, headerFilterFunc:minMaxFilterFunction, headerFilterLiveFilter:false},
            {title: "Dia da Semana", field:"Dia da Semana", editor:"list", width:100 ,headerFilter:true, headerFilterParams:{values:{"Seg":"Segunda-feira", "Ter":"Terça-feira", "Qua":"Quarta-feira", "Qui":"Quinta-feira" ,"Sex":"Sexta-feira", "Sab":"Sábado", "Dom":"Domingo"}}},
            {title: "Hora Início da Aula", field:"Hora Início da Aula",editor:"list", headerFilter:true, headerFilterParams:{values:{"08:00":"08:00", "08:30":"08:30", "09:00":"09:00", "09:30":"09:30", "10:00":"10:00", "10:30":"10:30", "11:00":"11:00", "11:30":"11:30", "12:00":"12:00", "12:30":"12:30", "13:00":"13:00", "13:30":"13:30", "14:00":"14:00", "14:30":"14:30", "15:00":"15:00", "15:30":"15:30", "16:00":"16:00", "16:30":"16:30", "17:00":"17:00", "17:30":"17:30", "18:00":"18:00", "18:30":"18:30", "19:00":"19:00", "19:30":"19:30", "20:00":"20:00", "20:30":"20:30","21:00":"21:00", "21:30":"21:30"}}},
            {title: "Hora Fim da Aula", field:"Hora Fim da Aula", editor:"list", headerFilter:true, headerFilterParams:{values:{"09:30":"09:30", "10:30":"10:30", "11:00":"11:00", "11:30":"11:30" ,"12:00":"12:00", "12:30":"12:30", "13:00":"13:00", "13:30":"13:30", "14:00":"14:00", "14:30":"14:30", "15:00":"15:00", "15:30":"15:30", "16:00":"16:00", "16:30":"16:30", "17:00":"17:00", "17:30":"17:30", "18:00":"18:00", "18:30":"18:30", "19:00":"19:00","19:30":"19:30","20:00":"20:00", "20:30":"20:30", "21:00":"21:00", "21:30":"21:30", "22:00":"22:00", "22:30":"22:30"}}},
            {title: "Data da aula", field:"Data da aula", headerFilter:"input", sorterParams:{format:"dd/MM/yy", alignEmptyValues:"top"}},
            {title: "Caracteristicas da sala pedida para a aula", field:"Caracteristicas da sala pedida para a aula", headerFilter:"input"},
            {title: "Sala atribuida a aula", field:"Sala atribuida a aula", headerFilter:"input"},
            {title: "Semana do ano", field:"Semana do ano", headerFilter: "input"},
            {title: "Semana do semestre", field:"Semana do semestre", headerFilter:"input"},
            {title: "Alterar aula", field: "Alterar aula", formatter: alterarAulaButton, headerSort:false}

        ],
    });


        const horarios = concatenateColumns(data, 'Hora Início da Aula', 'Hora Fim da Aula');
        console.log(horarios);

        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('alterar-aula-button')) {
                $('#myModal').modal('show');
            }
        });
    })
    .catch(error => {
        console.error(`Error loading ${pathJsonHorario}:`, error);
    });

    fetch(pathJsonSalas)
    .then(response => {
        // Verificar se o request foi bem sucedido
        if (!response.ok) {
            throw new Error(`Failed to fetch ${pathJsonSalas}: ${response.statusText}`);
        }

        // Parse the JSON data
        return response.json();
    })

    .then(data => {

        salas = data;

        /**
         * Adiciona tanto os tipos de sala como as próprias salas, específicados no documento
         * json da caracterização das salas ao primeiro input de preferência de sala e de 
         * salas inaceitáveis.
        */
        function initializeSelectOptionsSalas() {
            tiposDeSala = ['Anfiteatro', 'Arquitetura', 'BYOD', 'Focus Group', 'Laboratório de Arquitetura de Computadores', 'Laboratório de Bases de Engenharia', 'Laboratório de Electrónica', 'Laboratório de Informática', 'Laboratório de Jornalismo', 'Laboratório de Redes de Computadores', 'Laboratório de Telecomunicações', 'Sala Aulas Mestrado', 'Sala Aulas Mestrado Plus', 'Sala NEE', 'Sala Provas', 'Sala Reunião', 'Sala de Arquitectura', 'Sala de Aulas normal', 'videoconferência', 'Átrio'];
            nomesSalas = salas.map(room => room['Nome sala']);

            const preferenciaSala1 = document.getElementById('preferenciaSala1');
            const salasInaceitaveis = document.getElementById('salasInaceitaveis');

            // Adicionar cada tipo de sala existente aos respetivos inputs
            tiposDeSala.forEach(tipoDeSala => {
                const optionTipoSala = document.createElement('option');
                optionTipoSala.textContent = tipoDeSala;
                preferenciaSala1.appendChild(optionTipoSala);

                const OptionTipoSalaInaceitavel = document.createElement('option');
                OptionTipoSalaInaceitavel.textContent = tipoDeSala;
                salasInaceitaveis.appendChild(OptionTipoSalaInaceitavel);
            });

            
            // Adicionar cada sala existente no json com a Caracterização das Salas aos respetivos inputs
            nomesSalas.forEach(nomeSala => {
                const optionPreferencia1 = document.createElement('option');
                optionPreferencia1.textContent = nomeSala;
                preferenciaSala1.appendChild(optionPreferencia1);

                const optionSalasInaceitaveis = document.createElement('option');
                optionSalasInaceitaveis.textContent = nomeSala;
                salasInaceitaveis.appendChild(optionSalasInaceitaveis);
            });
        }

    initializeSelectOptionsSalas();


    })
    .catch(error => {
        console.error(`Error loading ${pathJsonSalas}:`, error);
    });

    

    /**
     *  Adiciona um evento de click ao botão para adicionar mais uma preferência de sala e ao botão
     *  para adicionar mais uma sala inaceitável. Este evento adiciona mais um input de prefrência ou
     *  de sala inaceitável, consoante o botão clicado. Este input irá conter os tipos de sala e as
     *  salas existentes no ficheiro json da caracterização das salas.
     *  
    */
    document.addEventListener('DOMContentLoaded', function () {
        const addButton = document.getElementById('addPreferenceBtn');
        const addButtonSalasIn =  document.getElementById('addSalaInaceitavel');;

        const preferencesContainer = document.getElementById('preferencias-container');
        const inaceitavelCointainer = document.getElementById('salasInaceitaveis-container');

        let preferenceCount = 1;
        let inaceitavelCount = 1;

        addButton.addEventListener('click', function () {
            preferenceCount++;

            // Adiciona um novo input para as salas preferidas
            const preferenceDiv = document.createElement('div');
            preferenceDiv.classList.add('form-group');
            preferenceDiv.innerHTML = `
                <p>Preferência nº${preferenceCount}:</p>
                <select class="form-select" id="preferenciaSala${preferenceCount}" aria-label="Default select example">
                    <option selected>Escolha uma Preferência</option>
                </select>
            `;

            preferencesContainer.appendChild(preferenceDiv);

            const novaPref = document.getElementById(`preferenciaSala${preferenceCount}`);

            // Adiciona as opções de tipo de sala ao novo input criado
            tiposDeSala.forEach(tipoDeSala => {
                const optionTipoSala = document.createElement('option');
                optionTipoSala.textContent = tipoDeSala;
                novaPref.appendChild(optionTipoSala);
            })

            // Adiciona as opções com as salas existentes ao novo input criado
            nomesSalas.forEach(nomeSala => {
                const optionSalas = document.createElement('option');
                optionSalas.textContent = nomeSala;
                novaPref.appendChild(optionSalas);
            });
        });

        addButtonSalasIn.addEventListener('click', function () {
            inaceitavelCount++;

            // Adiciona um novo input para as salas inaceitáveis
            const inaceitavelDiv = document.createElement('div');
            inaceitavelDiv.classList.add('form-group');
            inaceitavelDiv.innerHTML = `
                <p>Sala inaceitável nº${inaceitavelCount}:</p>
                <select class="form-select" id="salaInaceitavel${inaceitavelCount}" aria-label="Default select example">
                    <option selected>Escolha uma sala inaceitável</option>
                </select>
            `;

            inaceitavelCointainer.appendChild(inaceitavelDiv);

            const novaInaceitavel = document.getElementById(`salaInaceitavel${inaceitavelCount}`);

            // Adiciona as opções de tipo de sala ao novo input criado
            tiposDeSala.forEach(tipoDeSala => {
                const optionTipoSala = document.createElement('option');
                optionTipoSala.textContent = tipoDeSala;
                novaPref.appendChild(optionTipoSala);
            })

            // Adiciona as opções com as salas existentes ao novo input criado
            nomesSalas.forEach(nomeSala => {
                const optionSalas = document.createElement('option');
                optionSalas.textContent = nomeSala;
                novaInaceitavel.appendChild(optionSalas);
            });
        });
    });

    

     
    </script>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            const guardarButton = document.getElementById('guardarButton');

            guardarButton.addEventListener('click', function (event) {
                event.preventDefault(); 

                var semanaPrefValue = document.getElementById('semanaPref').value;
                var diaDaSemanaPrefValue = document.getElementById('diaDaSemanaPref').value.toLowerCase();
                //var alturaDoDiaPrefValue = document.getElementById('alturaDoDiaPref').value.toLowerCase();
                var preferenciaSala1Value = document.getElementById('preferenciaSala1').value.toLowerCase();
                var salasInaceitaveisValue = document.getElementById('salasInaceitaveis').value.toLowerCase();

                var filteredData = horario.filter(function (item) {
                    var semanaSemestre = item['Semana do semestre'];
                    var diaDaSemana = item['Dia da Semana'].toLowerCase();
                    //var horaInicio = item['Hora Inicio da Aula'].toLowerCase();
                    var caracteristicasSala = item['Caracteristicas da sala pedida para a aula'].toLowerCase();
                    var salaAtribuida = item['Sala atribuida a aula'].toLowerCase();

                    return semanaSemestre !== semanaPrefValue &&
                        !diaDaSemana.includes(diaDaSemanaPrefValue) &&
                        //horaInicio.includes(alturaDoDiaPrefValue) &&
                        (!caracteristicasSala.includes(preferenciaSala1Value) || !salaAtribuida.includes(preferenciaSala1Value)) &&
                        salasInaceitaveisValue.includes(salaAtribuida);
                });

                console.log(filteredData);
            });
        });

    </script>
    </div>
</body>
